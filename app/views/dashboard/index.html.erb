<!-- app/views/dashboard/index.html.erb -->
<h1 class="mb-3"><%= t('dashboard.title', default: 'Dashboard') %></h1>

<!-- Feedback quick link -->
<div class="d-flex justify-content-end mb-3">
  <%= link_to t('shared.feedback.link', default: "Send Feedback"),
              new_feedback_path,
              class: "btn btn-outline-primary btn-sm" %>
</div>

<div class="container">

  <!-- ========== Filters (Date Range + Quick Presets) ========== -->
  <div class="card mb-3">
    <div class="card-body">
      <%= form_with url: authenticated_root_path, method: :get, local: true, class: "row g-2 align-items-end" do |f| %>
        <div class="col-12 col-md-3">
          <label class="form-label"><%= t('dashboard.filters.start_date', default: 'Start date') %></label>
          <%= date_field_tag :start_date, params[:start_date] || (@range_start&.to_date), class: "form-control" %>
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label"><%= t('dashboard.filters.end_date', default: 'End date') %></label>
          <%= date_field_tag :end_date, params[:end_date] || (@range_end&.to_date), class: "form-control" %>
        </div>
        
        <div class="col-12 col-md-3">
          <label class="form-label"><%= t('dashboard.filters.quick', default: 'Quick') %></label>
          <%= select_tag(
                :quick,
                options_for_select(
                  [
                    [t('dashboard.quick.today',     default: 'Today'),        'today'],
                    [t('dashboard.quick.this_week', default: 'This Week'),    'this_week'],
                    [t('dashboard.quick.mtd',       default: 'MTD'),          'mtd'],
                    [t('dashboard.quick.last_30',   default: 'Last 30 Days'), 'last_30']
                  ],
                  # keep selection on reload
                  (params[:quick].presence || @quick)
                ),
                include_blank: true,
                class: "form-select",
                id: "quick-preset"
              ) %>
        </div>

        <div class="col-12 col-md-3 d-flex gap-2">
          <%= submit_tag t('shared.buttons.apply', default: 'Apply'), class: "btn btn-primary flex-grow-1" %>
          <%= link_to t('dashboard.download_pdf', default: 'Download PDF'),
                download_pdf_path(start_date: params[:start_date] || @range_start&.to_date,
                                  end_date:   params[:end_date]   || @range_end&.to_date,
                                  quick:      params[:quick]      || @quick),
                class: "btn btn-outline-secondary" %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- ========== KPI cards (Selected Range) ========== -->
  <div class="row g-3">
    <% kpi_cards = [
      [t('dashboard.cards.revenue_in_range',         default: 'Revenue'),        @revenue_in_range,      @spark_revenue_14d,  'bg-primary text-white'],
      [t('dashboard.cards.gross_margin_in_range',    default: 'Gross Margin'),   @gross_margin_in_range, @spark_margin_14d,   'bg-success text-white'],
      [t('dashboard.cards.avg_order_value_in_range', default: 'Avg Order'),      @avg_order_value_in_range, nil,                'bg-info text-dark'],
      [t('dashboard.cards.discounts_in_range',       default: 'Discounts'),      @discounts_in_range,    nil,                  'bg-warning text-dark'],
      [t('dashboard.cards.expenses_in_range',        default: 'Expenses'),       @expenses_in_range,     @spark_expenses_14d, 'bg-danger text-white'],
      [t('dashboard.cards.net_profit_in_range',      default: 'Net Profit'),     @net_profit_in_range,   nil,                  'bg-dark text-white']
    ] %>

    <% kpi_cards.each do |label, value, spark_data, klass| %>
      <div class="col-12 col-md-6 col-xl-2">
        <div class="card shadow-sm h-100 <%= klass %>">
          <div class="card-body">
            <div class="small opacity-75"><%= label %></div>
            <div class="fs-4 fw-semibold">
              <%= number_to_currency(value, unit: t('currency.unit', default: 'RWF '), precision: 0) %>
            </div>

            <%# Sparkline (tiny line) %>
            <% if defined?(line_chart) && spark_data.present? %>
              <div class="mt-2">
                <%= line_chart spark_data,
                      height: "60px",
                      library: {
                        plugins: { legend: { display: false } },
                        scales: { x: { display: false }, y: { display: false } },
                        elements: { point: { radius: 0 } }
                      },
                      thousands: ",",
                      prefix: t('currency.unit', default: 'RWF ') %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <!-- MTD vs Previous MTD tiny comparison -->
  <div class="text-muted small mt-1">
    <%= t('dashboard.labels.mtd', default: 'MTD Revenue') %>:
    <strong><%= number_to_currency(@mtd_revenue, unit: t('currency.unit', default: 'RWF '), precision: 0) %></strong>
    <% if @mtd_revenue_change_pct %>
      (<span class="<%= @mtd_revenue_change_pct >= 0 ? 'text-success' : 'text-danger' %>">
        <%= @mtd_revenue_change_pct %>%</span> <%= t('dashboard.labels.vs_prev_mtd', default: 'vs prev MTD') %>)
    <% end %>
  </div>

  <!-- ========== Charts Row ========== -->
  <div class="row g-3 mt-1">
    <!-- Line: Revenue vs Expenses -->
    <div class="col-12 col-xl-6">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="fw-semibold mb-2">
            <%= t('dashboard.headings.revenue_vs_expenses_selected_range', default: 'Revenue vs Expenses (Selected Range)') %>
          </div>
          <% if defined?(line_chart) %>
            <%= line_chart [
                  {name: t('dashboard.series.revenue',  default: 'Revenue'),  data: @daily_revenue},
                  {name: t('dashboard.series.expenses', default: 'Expenses'), data: @daily_expenses}
                ],
                library: {legend: {display: true}},
                thousands: ",",
                prefix: t('currency.unit', default: 'RWF '),
                points: false %>
          <% else %>
            <p class="text-muted"><%= t('dashboard.messages.charts_unavailable', default: 'Charts not available.') %></p>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Bar: Top Products by Revenue -->
    <div class="col-12 col-xl-6">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="fw-semibold mb-2">
            <%= t('dashboard.headings.top_products_by_revenue', default: 'Top Products by Revenue') %>
          </div>
          <% if defined?(column_chart) && @top_products_by_revenue.present? %>
            <%= column_chart @top_products_by_revenue.transform_keys { |(id, name)| name },
                thousands: ",",
                prefix: t('currency.unit', default: 'RWF ') %>
          <% else %>
            <p class="text-muted"><%= t('dashboard.messages.no_product_revenue', default: 'No product revenue in range.') %></p>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== Charts Row 2 ========== -->
  <div class="row g-3 mt-1">
    <!-- Pie: Revenue by Category -->
    <div class="col-12 col-xl-6">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="fw-semibold mb-2">
            <%= t('dashboard.headings.revenue_by_category', default: 'Revenue by Category') %>
          </div>
          <% if defined?(pie_chart) && @revenue_by_category.present? %>
            <%= pie_chart @revenue_by_category,
                thousands: ",",
                prefix: t('currency.unit', default: 'RWF ') %>
          <% else %>
            <p class="text-muted"><%= t('dashboard.messages.no_category_data', default: 'No category data available.') %></p>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Donut: Income vs Expenses -->
    <div class="col-12 col-xl-6">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="fw-semibold mb-2">
            <%= t('dashboard.headings.income_vs_expenses', default: 'Income vs Expenses') %>
          </div>
          <% if defined?(pie_chart) %>
            <%= pie_chart @income_vs_expenses, donut: true,
                thousands: ",",
                prefix: t('currency.unit', default: 'RWF ') %>
          <% else %>
            <p class="text-muted"><%= t('dashboard.messages.charts_unavailable', default: 'Charts not available.') %></p>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== Charts Row 3 (Stacked) ========== -->
  <div class="row g-3 mt-1">
    <div class="col-12">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="fw-semibold mb-2">
            <%= t('dashboard.headings.revenue_vs_cogs_vs_expenses', default: 'Revenue vs COGS vs Expenses (Stacked)') %>
          </div>
          <% if defined?(column_chart) %>
            <%= column_chart [
                  { name: t('dashboard.series.revenue',  default: 'Revenue'),  data: @daily_revenue },
                  { name: t('dashboard.series.cogs',     default: 'COGS'),     data: @daily_cogs },
                  { name: t('dashboard.series.expenses', default: 'Expenses'), data: @daily_expenses }
                ],
                stacked: true,
                thousands: ",",
                prefix: t('currency.unit', default: 'RWF ') %>
          <% else %>
            <p class="text-muted"><%= t('dashboard.messages.charts_unavailable', default: 'Charts not available.') %></p>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== Low Stock / Top-Selling (Qty) ========== -->
  <div class="row">
    <!-- Low Stock Products Card -->
    <div class="col-md-6">
      <div class="card mb-3 border-0 shadow-sm" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);">
        <div class="card-header bg-transparent fw-semibold">
          <%= t('dashboard.headings.low_stock_products', default: 'Low Stock Products') %>
        </div>
        <div class="card-body">
          <% if @low_stock_products.any? %>
            <% @low_stock_products.each do |product| %>
              <p class="mb-1">
                <strong><%= product.name %></strong>
                <span class="badge bg-dark ms-2">
                  <%= t('dashboard.labels.stock_left', default: 'Stock left') %>: <%= product.quantity %>
                </span>
              </p>
            <% end %>
          <% else %>
            <p class="text-muted mb-0">
              <%= t('dashboard.messages.all_stock_ok', default: 'All products have sufficient stock.') %>
            </p>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Top-Selling Products by Quantity -->
    <div class="col-md-6">
      <div class="card mb-3 border-0 shadow-sm" style="background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);">
        <div class="card-header bg-transparent fw-semibold">
          <%= t('dashboard.cards.top_selling_products', default: 'Top-Selling Products (Qty)') %>
        </div>
        <div class="card-body">
          <% if @top_selling_products.any? %>
            <% @top_selling_products.each do |product| %>
              <p class="mb-1">
                <strong><%= product.name %></strong>
                <span class="badge bg-secondary ms-2">
                  <%= t('dashboard.labels.sold', default: 'Sold') %>: <%= product.total_sold %>
                </span>
              </p>
            <% end %>
          <% else %>
            <p class="text-muted mb-0">
              <%= t('dashboard.messages.no_top_selling', default: 'No sales yet.') %>
            </p>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== Ransack sections with scroll + pagination ========== -->

  <!-- Products List -->
  <div class="row">
    <div class="col-md-12 mt-4">
      <h2><%= t('dashboard.headings.products', default: 'Products') %></h2>
      <%= search_form_for @q_products, url: authenticated_root_path, method: :get do |f| %>
        <div class="row g-2">
          <div class="col-md-10">
            <%= f.search_field :name_cont,
              placeholder: t('dashboard.tables.products.search_placeholder', default: 'Search products by name'),
              class: "form-control" %>
          </div>
          <div class="col-md-2">
            <%= f.submit t('shared.buttons.search', default: 'Search'), class: "btn btn-primary w-100" %>
          </div>
        </div>
      <% end %>

      <div class="table-responsive" style="max-height: 360px; overflow: auto;">
        <table class="table table-striped align-middle">
          <thead class="table-light position-sticky top-0">
            <tr>
              <th><%= t('dashboard.tables.products.columns.name', default: 'Name') %></th>
              <th><%= t('dashboard.tables.products.columns.category', default: 'Category') %></th>
              <th class="text-end"><%= t('dashboard.tables.products.columns.price', default: 'Price') %></th>
              <th class="text-end"><%= t('dashboard.tables.products.columns.quantity', default: 'Quantity') %></th>
            </tr>
          </thead>
          <tbody>
            <% @products.each do |product| %>
              <tr>
                <td><%= product.name %></td>
                <td><%= product.category %></td>
                <td class="text-end"><%= t('currency.unit', default: 'RWF ') %><%= product.price %></td>
                <td class="text-end"><%= product.quantity %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <div class="d-flex justify-content-end">
        <%= paginate @products, param_name: :products_page %>
      </div>
    </div>

    <!-- Sales List -->
    <div class="col-md-12 mt-4">
      <h2><%= t('dashboard.headings.sales', default: 'Sales') %></h2>
      <%= search_form_for @q_sales, url: authenticated_root_path, method: :get do |f| %>
        <div class="row g-2">
          <div class="col-md-10">
            <%= f.search_field :product_name_cont,
              placeholder: t('dashboard.tables.sales.search_placeholder', default: 'Search sales by product'),
              class: "form-control" %>
          </div>
          <div class="col-md-2">
            <%= f.submit t('shared.buttons.search', default: 'Search'), class: "btn btn-primary w-100" %>
          </div>
        </div>
      <% end %>

      <div class="table-responsive" style="max-height: 360px; overflow: auto;">
        <table class="table table-striped align-middle">
          <thead class="table-light position-sticky top-0">
            <tr>
              <th><%= t('dashboard.tables.sales.columns.product', default: 'Product') %></th>
              <th class="text-end"><%= t('dashboard.tables.sales.columns.quantity', default: 'Qty') %></th>
              <th class="text-end"><%= t('dashboard.tables.sales.columns.total_price', default: 'Total Price') %></th>
              <th><%= t('dashboard.tables.sales.columns.date', default: 'Date') %></th>
            </tr>
          </thead>
          <tbody>
            <% @sales.each do |sale| %>
              <tr>
                <td><%= sale.product&.name %></td>
                <td class="text-end"><%= sale.quantity %></td>
                <td class="text-end"><%= t('currency.unit', default: 'RWF ') %><%= sale.total_price %></td>
                <td><%= l(sale.date, format: :ymd) %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <div class="d-flex justify-content-end">
        <%= paginate @sales, param_name: :sales_page %>
      </div>
    </div>

    <!-- Income List -->
    <div class="col-md-12 mt-4">
      <h2><%= t('dashboard.headings.incomes', default: 'Income') %></h2>
      <%= search_form_for @q_incomes, url: authenticated_root_path, method: :get do |f| %>
        <div class="row g-2">
          <div class="col-md-10">
            <%= f.search_field :name_cont,
              placeholder: t('dashboard.tables.incomes.search_placeholder', default: 'Search income by name'),
              class: "form-control" %>
          </div>
          <div class="col-md-2">
            <%= f.submit t('shared.buttons.search', default: 'Search'), class: "btn btn-primary w-100" %>
          </div>
        </div>
      <% end %>

      <div class="table-responsive" style="max-height: 360px; overflow: auto;">
        <table class="table table-striped align-middle">
          <thead class="table-light position-sticky top-0">
            <tr>
              <th><%= t('dashboard.tables.incomes.columns.name', default: 'Name') %></th>
              <th><%= t('dashboard.tables.incomes.columns.category', default: 'Category') %></th>
              <th class="text-end"><%= t('dashboard.tables.incomes.columns.amount', default: 'Amount') %></th>
              <th><%= t('dashboard.tables.incomes.columns.date', default: 'Date') %></th>
            </tr>
          </thead>
          <tbody>
            <% @incomes.each do |income| %>
              <tr>
                <td><%= income.name %></td>
                <td><%= income.category %></td>
                <td class="text-end"><%= t('currency.unit', default: 'RWF ') %><%= income.amount %></td>
                <td><%= l(income.date, format: :ymd) %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <div class="d-flex justify-content-end">
        <%= paginate @incomes, param_name: :incomes_page %>
      </div>
    </div>

    <!-- Expenses List -->
    <div class="col-md-12 mt-4 mb-5">
      <h2><%= t('dashboard.headings.expenses', default: 'Expenses') %></h2>
      <%= search_form_for @q_expenses, url: authenticated_root_path, method: :get do |f| %>
        <div class="row g-2">
          <div class="col-md-10">
            <%= f.search_field :name_cont,
              placeholder: t('dashboard.tables.expenses.search_placeholder', default: 'Search expenses by name'),
              class: "form-control" %>
          </div>
          <div class="col-md-2">
            <%= f.submit t('shared.buttons.search', default: 'Search'), class: "btn btn-primary w-100" %>
          </div>
        </div>
      <% end %>

      <div class="table-responsive" style="max-height: 360px; overflow: auto;">
        <table class="table table-striped align-middle">
          <thead class="table-light position-sticky top-0">
            <tr>
              <th><%= t('dashboard.tables.expenses.columns.name', default: 'Name') %></th>
              <th><%= t('dashboard.tables.expenses.columns.category', default: 'Category') %></th>
              <th class="text-end"><%= t('dashboard.tables.expenses.columns.amount', default: 'Amount') %></th>
              <th><%= t('dashboard.tables.expenses.columns.date', default: 'Date') %></th>
            </tr>
          </thead>
          <tbody>
            <% @expenses.each do |expense| %>
              <tr>
                <td><%= expense.name %></td>
                <td><%= expense.category %></td>
                <td class="text-end"><%= t('currency.unit', default: 'RWF ') %><%= expense.amount %></td>
                <td><%= l(expense.date, format: :ymd) %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <div class="d-flex justify-content-end">
        <%= paginate @expenses, param_name: :expenses_page %>
      </div>
    </div>
  </div>
  <!-- put this near the bottom of index.html.erb (once per page) -->
  <script>
  document.addEventListener('turbo:load', function () {
    var select = document.getElementById('quick-preset');
    if (!select) return;

    select.addEventListener('change', function () {
      var v = this.value;
      var form = this.form;
      if (!form) return;

      // If a preset is chosen, clear date fields (so UI reflects preset cleanly)
      if (v) {
        var start = form.querySelector('input[name="start_date"]');
        var end   = form.querySelector('input[name="end_date"]');
        if (start) start.value = '';
        if (end)   end.value   = '';
        form.submit();
      }
    });
  });
  </script>
</div>
